#+TITLE:Drought awap grids 
#+AUTHOR: Ivan Hanigan
#+email: ivan.hanigan@anu.edu.au
#+LaTeX_CLASS: article
#+LaTeX_CLASS_OPTIONS: [a4paper]
#+LATEX_HEADER: \usepackage{amssymb,amsmath}
#+LATEX: \hypersetup{hidelinks=true}
#+LATEX: \tableofcontents
-----
* worklog
** 2016-08-26 notes re set up github repository
- I think this belongs on swish-climate-impact-assessment rather than ivanhanigan github
- because that way more people might get involved
** 2016-08-27-drought-awap-grids-notes re extract point
#+name:notes re extract point-header
#+begin_src markdown :tangle ~/projects/ivanhanigan.github.com.raw/_posts/2016-08-27-drought-awap-grids-notes-re-extract-point.md :exports none :eval no :padline no
---
name: drought-awap-grids-notes-re-extract-point
layout: post
title: drought-awap-grids-notes-re-extract-point
date: 2016-08-27
categories:
- drought awap grids
---

## Background

- The old DROUGHT-BOM-GRIDS data came from a Barnes IDW algorithm, at 25km (actually 0.25 decimal degrees) resolution
- 1890-2008
- Going forward the AWAP grids are Preferred
- this is a quick and dirty approach

## Methods

- AWAP grids are 5km (0.05 dd) but this will take longer to process and is probably overkill for monthly total rainfall when focus is on drought
- For the centroid point of each 0.25 dd extract the data value (might be better to take mean of sub-cells within each, plan for future)
- compare this with old BOM GRIDS

## Results

![images/qc_awap_totals_200001.png](images/qc_awap_totals_200001.png)
    

### compare with bom grids for Jan 2000

![images/qc_awap_200001_vs_bomgrids.png](images/qc_awap_200001_vs_bomgrids.png)

### For a pixel (west wyalong my old home town)

![images/qc_awap_1900_1908_vs_bomgrids_west_wyalong.png](images/qc_awap_1900_1908_vs_bomgrids_west_wyalong.png)

#+end_src

** 2016-09-02-notes re get ready to predict-pasture-district-declared-drought-using-climatic-drought
- changed do to take 6 or 12
* README
#+name:README
#+begin_src R :session *R* :tangle README.md :exports none :eval no
# DROUGHT-AWAP-GRIDS	

- Creator: Ivan Hanigan
- Contact Email:	ivan.hanigan@gmail.com

Abstract: 
===

- Aim: To update the Australian drought dataset. Background: The old project DROUGHT BOM-GRIDS 
- Methods: Using the Hutchinson Drought Index (Hanigan, I., Porfirio, L. and Hutchinson, M. (2012). The Hutchinson Drought Index Algorithm. https://github.com/ivanhanigan/HutchinsonDroughtIndex) compute the Drought Indices. Use the same 25km grids as the old BOM-GRIDS dataset, but use the new AWAP-GRIDS data.
- License: CC-By Attribution 4.0 International

Requires:
===

1. `DROUGHT-BOM-GRIDS`, https://github.com/swish-climate-impact-assessment/DROUGHT-BOM-GRIDS, for the grid shapefiles
1. `AWAPTOOLS`, https://github.com/swish-climate-impact-assessment/awaptools, to download and format the grids
1. `AWAP_GRIDS`, https://github.com/swish-climate-impact-assessment/AWAP_GRIDS, to run `awaptools`, for the monthly total rainfall grids
1. `HutchinsonDroughtIndex`, https://osf.io/pyts3/, for computing the indices





#+end_src

* data
*** func
#+name:func
#+begin_src R :session *shell* :tangle code/func.R :exports none :eval no
'name:func'
library(rgdal)
library(raster)
if(!require(HutchinsonDroughtIndex)){
library(devtools)
install_github("ivanhanigan/HutchinsonDroughtIndex")
library(HutchinsonDroughtIndex)
} 

#+end_src

*** main
#+name:main
#+begin_src R :session *shell* :tangle main.R :exports none :eval no
  'name:main'
  # Project: DROUGHT-AWAP-GRIDS
  # Author: Your Name
  # Maintainer: Who to complain to <yourfault@somewhere.net>
  
  # This is the main file for the project
  # It should do very little except call the other files
  
  ### Set the working directory
  projdir <- "~/projects/DROUGHT-AWAP-GRIDS"
  setwd(projdir)
  source("code/func.R")
  
#+end_src
*** COMMENT step one get prediction points (DEPRECATED TET)
#+begin_src R :session *shell* :tangle no :exports none :eval no  
  projdir <- "~/projects/DROUGHT-AWAP-GRIDS"
  setwd(projdir)
  source("code/func.R")
  
  indir <- "~/projects/DROUGHT-BOM-GRIDS/data_derived"
  dir(indir)
  setwd(indir)
  shp  <- readOGR(".", "grid_nsw")
  setwd(projdir)
  
  
  str(shp)
  shp2 <- rgeos::gCentroid(shp, byid = T)
  plot(shp)
  plot(shp2, add = T, pch = 16)
  
#+end_src
*** step two extract from grids
#+name:extract from awapgrids
#+begin_src R :session *shell* :tangle main.R :exports none :eval no
  'name:extract from awapgrids'
  
  indir  <- "~/data/AWAP_GRIDS/data"
  infilelist <- dir(indir, pattern = ".tif$", full.names=T)
  infilelist <- infilelist[grep("total", infilelist)]
  infilelist[grep("200001", infilelist)]
  states  <- c("act", "nsw", "nt",  "qld", "sa",  "tas", "vic", "wa")
  for(ste in states[1:4]){
  #  ste  <- "act"
    outfile_main  <- paste("rain_", ste, "_1900_2015.csv", sep  = "")
    indir_shp <- "~/projects/DROUGHT-BOM-GRIDS/data_derived"
    #gsub("\\.shp","",gsub("grid_", "", dir(indir_shp, pattern = ".shp")))
    setwd(indir_shp)
    shp  <- readOGR(".", sprintf("grid_%s", ste))
    setwd(projdir)
    
    
    #str(shp)
    shp2 <- rgeos::gCentroid(shp, byid = T)
  #  plot(shp)
  #  plot(shp2, add = T, pch = 16)
  
  
      
  for(i in 1:length(infilelist)){
    #i = 1
    infile <- infilelist[i]
    outfile <- gsub("GTif_", "", gsub(".tif", "", basename(infile)))
    y  <- substr(outfile, 8, 8 +3)
    m  <- substr(outfile, 8 +4, 8+5)
    
    #print(infile)
    r  <- raster(infile)
    shpout <- shp
    #plot(r)
    #plot(shp2, add = T)
    #shp2 <- shp
    e <- extract(r, shp2)
    #str(e)
    #e[1]
    shpout@data <- data.frame(shp@data, e)
    #str(shpout@data)
    #dir()
    #writeOGR(shpout, "data_derived",
    #  outfile
    #  , driver = "ESRI Shapefile", overwrite_layer=T)
    csvout <- shpout@data
    csvout$the_geom  <- NULL
    csvout$the_geom_p  <- NULL
    csvout$wronglatit  <- NULL
    csvout$admin_name  <- NULL  
    names(csvout) <- gsub("^e$", "rain", names(csvout))
    csvout$year <- as.numeric(y)
    csvout$month <- as.numeric(m)
  #  str(csvout)
    write.table(csvout,
              file.path("data_derived", outfile_main)
              , sep = ",", append = i != 1,
              col.names = i == 1, row.names = F)
  }
  }
#+end_src
*** COMMENT QC local againset BOMGRIDS
#+name:QC
#+begin_src R :session *shell* :tangle code/qc_checks_against_old_bomgrids.R :exports none :eval no
  'name:QC'

  # QC
  ch <- swishdbtools::connect2postgres2("ewedb_staging")
  qc <- dbGetQuery(ch,
  "select *
  from bom_grids.rain_nsw_1890_2008_4
  where year = 2000 and month = 1")
  
  str(qc)
  str(shpout@data)
  
  qc2 <- merge(shpout@data, qc, by = "gid")
  qc2$the_geom  <- NULL
  head(qc2)
  png("figures_and_tables/qc_awap_200001_vs_bomgrids.png")
  plot(qc2$rain, qc2$e)
  dev.off()
  
  # QC2
  qc2 <- read.csv(file.path("data_derived", outfile_main), as.is = T)
  head(qc2)
  qc2$date <- as.Date(paste(qc2$year, qc2$month, 1, sep = "-"))
  head(table(qc2$gid))
  
  qc3 <- dbGetQuery(ch,
  "select *
  from bom_grids.rain_nsw_1890_2008_4
  where gid = 7568")
  qc3$date <- as.Date(paste(qc3$year, qc3$month, 1, sep = "-"))
  
  png("figures_and_tables/qc_awap_1900_1908_vs_bomgrids_west_wyalong.png")
  with(qc2[qc2$gid == 7568,],
       plot(date, rain, type = "l")
       )
  with(qc3[qc3$gid == 7568,],
       lines(date, rain, col = 'red')
       )
  dev.off()
  
  
#+end_src
*** COMMENT step 3 calculate drought index (tip, copy one for each state, poor mans parralelisation)
#+name:step 3 calculate drought index
#+begin_src R :session *shell* :tangle code/do_calc_index.R :exports none :eval no
  'name:step 3 calculate drought index'
  projdir <- "~/projects/DROUGHT-AWAP-GRIDS"
  setwd(projdir)
  source("code/func.R")
  library(HutchinsonDroughtIndex)
  indir <- "data_derived"
  
  states  <- c("act", "nsw", "nt",  "qld", "sa",  "tas", "vic", "wa")
  
  for(ste in states[1]){
  #  ste  <- "act"
  infile <- paste("rain_",ste,"_1900_2015.csv", sep = "")
  
  for(m_i in c(6, 12)){
    outfile_main  <- paste("rain_",ste,"_1900_2015_drought",m_i,".csv", sep = "")
    dat <- read.csv(file.path(indir, infile), as.is = T)
    #str(dat)
     
    dat$date  <- as.Date(paste(dat$year, dat$month, 1, sep = "-"))
    dat <- dat[,c("gid", "date","year","month","rain")]
    #tail(dat)
    #head(dat)
     
      ##############################################
      # do the drought algorithm
      gids <- names(table(dat$gid))
      #gids
      for(i in 1:length(gids)){
      #  gid_i  <- gids[1]
        gid_i <- gids[i]
        dat_i <- dat[dat$gid == gid_i,c("date", "year", "month", "rain")]
      #str(dat_i)
      drt <- drought_index_stations(
        data=dat_i
        ,
        years=length(names(table(dat$year)))
        ,
        M = m_i
        ,
        droughtThreshold = 0.375
        )
      #head(drt)
      drt$gid  <- gid_i
      write.table(drt,
                file.path("data_derived", outfile_main)
                , sep = ",", append = i != 1,
                col.names = i == 1, row.names = F)
       
      }
     
    }
  }
  
#+end_src
*** COMMENT qc_on_server
#+name:qc_on_server
#+begin_src R :session *R* :tangle code/qc_on_server.R :exports none :eval no
  'name:qc_on_server'
  # with GID = 6378
  write.csv(drt, file.path('data_derived/act_drought_1900_2015_20160829.csv'), row.names = F)
  png("figures_and_tables/qc_act_drought.png")
  par(mfrow = c(2,1))
  plot(drt$date, drt$rain, type = "l")
  plot(drt$date, drt$count2, type = "l")
  segments(min(drt$date), 5, max(drt$date), 5)
  dev.off()
    
  
  
  # QC
  # http://www.cbsnews.com/news/droughts-the-next-great-threat-to-iraq/
  # this says drought from 2007 to 2010
  qc <- drt[drt$year>=2000 & drt$year < 2016,]
  head(qc, 12)
  57.5+30.8+67.9+50.6+62.9+43.3
  
  png(file.path('figures_and_tables','qc_act_drought_2000_2015.png'),res=200,width = 2100, height = 1000)
  par(mfrow=c(4,1),mar=c(2.5,2,1.5,1))
  plot(qc$date,qc$rain,type='l',main='ACT: raw monthly rainfall')
  #points(qc$date,qc$rain)
  
  lines(qc$date,qc$sixmnthtot/6, lwd = 2) #,type='l',main='6-monthly total rainfall')
  points(qc$date,qc$sixmnthtot/6)
  
  plot(qc$date,qc$index,type='l',main='Rescaled percentiles -4 to +4, -1 is Palmer Index Mild Drought',ylim=c(-4,4))
  points(qc$date,qc$index)
  segments(min(qc$date),-1,max(qc$date),-1)
  segments(min(qc$date),0,max(qc$date),0,lty=2)
  plot(qc$date,qc$count,type='l',main='Counts below -1 threshold, count of 5 or more is a drought')
  points(qc$date,qc$count)
  segments(min(qc$date),5,max(qc$date),5)
  
  plot(qc$date,qc$count2,type='l',main='Enhanced counts of months if already passed count of 5 and percentiles less than 50%')
  points(qc$date,qc$count2)
  segments(min(qc$date),5,max(qc$date),5)
  dev.off()
  
  
  dir()
#+end_src
*** COMMENT QC2 on local
#+name:QC
#+begin_src R :session *R* :tangle code/qc_checks_against_old_bomgrids2.R :exports none :eval no
  'name:QC'
  library(swishdbtools)
  projdir <- "~/projects/DROUGHT-AWAP-GRIDS"
  setwd(projdir)
  source("code/func.R")
  
  # QC
  ch <- swishdbtools::connect2postgres2("ewedb_staging")
  qc <- dbGetQuery(ch,
  "select *
  from bom_grids.rain_act_1890_2008_4
  where year > 1978
  ")
  
  str(qc)
  
  # QC2
  dir("data_derived")
  infile <- "rain_act_1900_2015_drought.csv"
  qc2 <- read.csv(file.path("data_derived", infile), as.is = T)
  head(qc2)
  table(qc2$gid)
  head(table(qc2$gid))
  
  qc3 <- merge(qc, qc2, by = c("gid", "year", "month"))
  str(qc3)
  qc3$date <- as.Date(qc3$date)
  qc3 <- qc3[order(qc3$date),]
  #png("figures_and_tables/qc_awap_vs_bom_act.png")
  par(mfrow=c(2,2))
  with(qc3,
       plot(rain.x, rain.y, col = as.factor(qc3$gid), pch = 16, cex = .6,
            ylim = c(0,450), xlim = c(0,450)
            )
       )
  for(gid_i in names(table(qc3$gid))){
  #  gid_i  <- names(table(qc3$gid))[1]
  with(qc3[qc3$gid == gid_i,],
       plot(date, count.x, type = "l", lwd = 2
            )
       )
  with(qc3[qc3$gid == gid_i,],
       lines(date, count.y, col = 'red')
       )
  segments(min(qc3$date), 5, max(qc3$date))
  title(gid_i)
  }
  
  dev.off()
  
  
#+end_src
*** COMMENT do_convert2shp
#+name:do_convert2shp
#+begin_src R :session *R* :tangle code/do_convert2shp.R :exports none :eval no
  'name:do_convert2shp'
  projdir <- "~/projects/DROUGHT-AWAP-GRIDS"
  setwd(projdir)
  source("code/func.R")
  states  <- c("act", "nsw", "nt",  "qld", "sa",  "tas", "vic", "wa")
  #for(ste in states[1:4]){
    ste  <- "nsw"
  
    indir_shp <- "~/projects/DROUGHT-BOM-GRIDS/data_derived"
    #gsub("\\.shp","",gsub("grid_", "", dir(indir_shp, pattern = ".shp")))
    setwd(indir_shp)
    shp  <- readOGR(".", sprintf("grid_%s", ste))
    setwd(projdir)
    #plot(shp)
    infile <- paste("rain_",ste,"_1900_2015_drought.csv", sep = "")
    indat <- read.csv(file.path("data_derived", infile), as.is = T)
    #str(indat)
    head(indat)
    # do loop
    for(y in c(2002:2003)){
     # y  <- 2004
      for(m in 1:12){
      #  m  <- 4
      m2 <- sprintf("%02d", m)
    outfile_main  <- paste("drought_awap_grids_", ste, "_",y,"_",m2, sep  = "")
  
    indat_i <- indat[indat$year == y & indat$month == m,]
    indat_i$drought_count_5  <- ifelse(indat_i$count >= 5, 1, 0)
    #str(indat_i)
    outdat <- shp
    outdat@data <- data.frame(outdat@data, indat_i[match(outdat@data[,"gid"], indat_i[,"gid"]),])
    writeOGR(outdat, "data_derived_shapefiles",
     outfile_main
     , driver = "ESRI Shapefile", overwrite_layer=T)
      }
    }
  #}  
#+end_src
*** COMMENT QC local againset BOMGRIDS shapefile october 1986
#+name:QC
#+begin_src R :session *R* :tangle code/qc_checks_against_old_bomgrids.R :exports none :eval no
  'name:QC'
  
  # QC
  ch <- swishdbtools::connect2postgres2("ewedb_staging")
  qc <- dbGetQuery(ch,
  "select *
  from bom_grids.rain_nsw_1890_2008_4
  where year = 1986 and month = 10")
  
  str(qc)
  str(shp@data)
  outdata2 <- shp
  outdata2@data <- data.frame(outdata2@data, qc[match(outdata2@data[,"gid"],
                                                      qc[,"gid"]),
                                                ])
  dir("figures_and_tables")
  writeOGR(outdata2, "figures_and_tables",
           "qc_drought_bom_grids_nsw_1986_10", driver = "ESRI Shapefile")
  
#+end_src
